"""–û–±—Ä–∞–±–æ—Ç—á–∏–∫ FAQ –¥–ª—è –ö–∞–Ω–∞–ª–¢–µ—Ö–°–µ—Ä–≤–∏—Å."""
from telegram import Update
from telegram.ext import ContextTypes
from ..keyboards import Keyboards
import logging

logger = logging.getLogger(__name__)


class FAQHandler:
    """–ö–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å FAQ."""

    def __init__(self, db):
        self.db = db
        self.kb = Keyboards()
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º FAQ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç –≤ –ë–î
        self.init_default_faq()

    def init_default_faq(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è FAQ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é."""
        default_faqs = [
            {
                "category": "general",
                "question": "–ö–∞–∫–∏–µ —É—Å–ª—É–≥–∏ –≤—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç–µ?",
                "answer": (
                    "–ö–∞–Ω–∞–ª–¢–µ—Ö–°–µ—Ä–≤–∏—Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ–ª–Ω—ã–π —Å–ø–µ–∫—Ç—Ä –∞—Å—Å–µ–Ω–∏–∑–∞—Ç–æ—Ä—Å–∫–∏—Ö —É—Å–ª—É–≥:\n"
                    "üö∞ –û—Ç–∫–∞—á–∫–∞ —Å–µ–ø—Ç–∏–∫–æ–≤ –∏ –≤—ã–≥—Ä–µ–±–Ω—ã—Ö —è–º\n"
                    "üîß –ü—Ä–æ—á–∏—Å—Ç–∫–∞ –∫–∞–Ω–∞–ª–∏–∑–∞—Ü–∏–∏\n"
                    "üö® –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞—Å–æ—Ä–æ–≤\n"
                    "üèóÔ∏è –ú–æ–Ω—Ç–∞–∂ –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ —Å–µ–ø—Ç–∏–∫–æ–≤\n"
                    "üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∫–∞–Ω–∞–ª–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º"
                ),
                "order_num": 1
            },
            {
                "category": "pricing",
                "question": "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ—è—Ç –≤–∞—à–∏ —É—Å–ª—É–≥–∏?",
                "answer": (
                    "–°—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –æ–±—ä–µ–º–∞ —Ä–∞–±–æ—Ç:\n\n"
                    "üí∞ –û—Ç–∫–∞—á–∫–∞ —Å–µ–ø—Ç–∏–∫–∞:\n"
                    "  ‚Ä¢ –î–æ 5 –º¬≥ - –æ—Ç 2500 —Ä—É–±\n"
                    "  ‚Ä¢ 5-10 –º¬≥ - –æ—Ç 4000 —Ä—É–±\n"
                    "  ‚Ä¢ –°–≤—ã—à–µ 10 –º¬≥ - –æ—Ç 6000 —Ä—É–±\n\n"
                    "üîß –ü—Ä–æ—á–∏—Å—Ç–∫–∞ –∫–∞–Ω–∞–ª–∏–∑–∞—Ü–∏–∏:\n"
                    "  ‚Ä¢ –ü—Ä–æ—Å—Ç–æ–π –∑–∞—Å–æ—Ä - –æ—Ç 1500 —Ä—É–±\n"
                    "  ‚Ä¢ –°–ª–æ–∂–Ω—ã–π –∑–∞—Å–æ—Ä - –æ—Ç 3000 —Ä—É–±\n\n"
                    "–¢–æ—á–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å —É—Ç–æ—á–Ω—è–π—Ç–µ —É –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞!"
                ),
                "order_num": 1
            },
            {
                "category": "timing",
                "question": "–ö–∞–∫ –±—ã—Å—Ç—Ä–æ –≤—ã –ø—Ä–∏–µ–¥–µ—Ç–µ?",
                "answer": (
                    "‚è±Ô∏è –ú—ã —Ä–∞–±–æ—Ç–∞–µ–º –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ:\n\n"
                    "‚Ä¢ –°—Ä–æ—á–Ω—ã–π –≤—ã–µ–∑–¥ - –≤ —Ç–µ—á–µ–Ω–∏–µ 2 —á–∞—Å–æ–≤\n"
                    "‚Ä¢ –ü–ª–∞–Ω–æ–≤—ã–π –≤—ã–µ–∑–¥ - –≤ —É–¥–æ–±–Ω–æ–µ –¥–ª—è –≤–∞—Å –≤—Ä–µ–º—è\n"
                    "‚Ä¢ –†–∞–±–æ—Ç–∞–µ–º 24/7, –≤–∫–ª—é—á–∞—è –≤—ã—Ö–æ–¥–Ω—ã–µ –∏ –ø—Ä–∞–∑–¥–Ω–∏–∫–∏\n\n"
                    "–ü—Ä–∏ —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö –≥–æ—Ç–æ–≤—ã –≤—ã–µ—Ö–∞—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ!"
                ),
                "order_num": 1
            },
            {
                "category": "schedule",
                "question": "–í –∫–∞–∫–æ–µ –≤—Ä–µ–º—è –≤—ã —Ä–∞–±–æ—Ç–∞–µ—Ç–µ?",
                "answer": (
                    "üïê –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã:\n\n"
                    "‚Ä¢ –ö—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ, 7 –¥–Ω–µ–π –≤ –Ω–µ–¥–µ–ª—é\n"
                    "‚Ä¢ –ë–µ–∑ –ø–µ—Ä–µ—Ä—ã–≤–æ–≤ –∏ –≤—ã—Ö–æ–¥–Ω—ã—Ö\n"
                    "‚Ä¢ –ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ –¥–Ω–∏ - —Ä–∞–±–æ—Ç–∞–µ–º\n\n"
                    "üìû –î–∏—Å–ø–µ—Ç—á–µ—Ä—Å–∫–∞—è —Å–ª—É–∂–±–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ 24/7"
                ),
                "order_num": 2
            },
        ]
        
        # TODO: –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –≤—Å—Ç–∞–≤–∫–∏ FAQ –≤ –ë–î
        # –°–µ–π—á–∞—Å –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º
        logger.info(f"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ {len(default_faqs)} FAQ –∑–∞–ø–∏—Å–µ–π")

    async def show_faq_menu(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é FAQ."""
        await update.message.reply_text(
            "‚ùì **–ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã**\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:",
            parse_mode='Markdown',
            reply_markup=self.kb.faq_categories()
        )

    async def show_faq_category(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∫–∞–∑–∞—Ç—å FAQ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏."""
        query = update.callback_query
        await query.answer()

        if query.data == "back_main":
            await query.edit_message_text("–í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é...")
            return

        category_map = {
            "faq_general": "general",
            "faq_pricing": "pricing",
            "faq_timing": "timing",
            "faq_schedule": "schedule"
        }

        category = category_map.get(query.data)
        if not category:
            await query.edit_message_text("‚ùå –ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
            return

        faqs = self.db.get_faq_items(category=category)
        
        if not faqs:
            await query.edit_message_text(
                "–í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤.",
                reply_markup=self.kb.faq_categories()
            )
            return

        text = "‚ùì **–ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã:**\n\n"
        
        for faq in faqs:
            text += f"**‚ùî {faq['question']}**\n{faq['answer']}\n\n"

        await query.edit_message_text(
            text,
            parse_mode='Markdown',
            reply_markup=self.kb.faq_categories()
        )
