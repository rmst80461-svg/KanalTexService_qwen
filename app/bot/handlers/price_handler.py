"""–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–∞ –¥–ª—è –ö–∞–Ω–∞–ª–¢–µ—Ö–°–µ—Ä–≤–∏—Å."""
from telegram import Update
from telegram.ext import ContextTypes
from ..keyboards import Keyboards
import logging

logger = logging.getLogger(__name__)


class PriceHandler:
    """–ö–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–æ–º."""

    def __init__(self, db):
        self.db = db
        self.kb = Keyboards()
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ü–µ–Ω—ã –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
        self.init_default_prices()

    def init_default_prices(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ü–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é."""
        default_prices = [
            # –û—Ç–∫–∞—á–∫–∞ —Å–µ–ø—Ç–∏–∫–æ–≤
            {"category": "–û—Ç–∫–∞—á–∫–∞ —Å–µ–ø—Ç–∏–∫–æ–≤", "service_name": "–î–æ 5 –º¬≥", "base_price": 2500, "description": "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –æ—Ç–∫–∞—á–∫–∞"},
            {"category": "–û—Ç–∫–∞—á–∫–∞ —Å–µ–ø—Ç–∏–∫–æ–≤", "service_name": "5-10 –º¬≥", "base_price": 4000, "description": "–°—Ä–µ–¥–Ω–∏–π –æ–±—ä–µ–º"},
            {"category": "–û—Ç–∫–∞—á–∫–∞ —Å–µ–ø—Ç–∏–∫–æ–≤", "service_name": "–°–≤—ã—à–µ 10 –º¬≥", "base_price": 6000, "description": "–ë–æ–ª—å—à–æ–π –æ–±—ä–µ–º"},
            {"category": "–û—Ç–∫–∞—á–∫–∞ —Å–µ–ø—Ç–∏–∫–æ–≤", "service_name": "–°—Ä–æ—á–Ω–∞—è –æ—Ç–∫–∞—á–∫–∞ (2 —á–∞—Å–∞)", "base_price": 3500, "description": "–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π –≤—ã–µ–∑–¥"},
            
            # –ü—Ä–æ—á–∏—Å—Ç–∫–∞ –∫–∞–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
            {"category": "–ü—Ä–æ—á–∏—Å—Ç–∫–∞ –∫–∞–Ω–∞–ª–∏–∑–∞—Ü–∏–∏", "service_name": "–ü—Ä–æ—Å—Ç–æ–π –∑–∞—Å–æ—Ä", "base_price": 1500, "description": "–ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ—á–∏—Å—Ç–∫–∞"},
            {"category": "–ü—Ä–æ—á–∏—Å—Ç–∫–∞ –∫–∞–Ω–∞–ª–∏–∑–∞—Ü–∏–∏", "service_name": "–°–ª–æ–∂–Ω—ã–π –∑–∞—Å–æ—Ä", "base_price": 3000, "description": "–° –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–ø–µ—Ü–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è"},
            {"category": "–ü—Ä–æ—á–∏—Å—Ç–∫–∞ –∫–∞–Ω–∞–ª–∏–∑–∞—Ü–∏–∏", "service_name": "–ì–∏–¥—Ä–æ–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –ø—Ä–æ—á–∏—Å—Ç–∫–∞", "base_price": 4500, "description": "–í—ã—Å–æ–∫–æ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è"},
            
            # –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞—Å–æ—Ä–æ–≤
            {"category": "–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞—Å–æ—Ä–æ–≤", "service_name": "–£–Ω–∏—Ç–∞–∑/—Ä–∞–∫–æ–≤–∏–Ω–∞", "base_price": 1200, "description": "–õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞—Å–æ—Ä"},
            {"category": "–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞—Å–æ—Ä–æ–≤", "service_name": "–°—Ç–æ—è–∫", "base_price": 2500, "description": "–ü—Ä–æ—á–∏—Å—Ç–∫–∞ —Å—Ç–æ—è–∫–∞"},
            {"category": "–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞—Å–æ—Ä–æ–≤", "service_name": "–ù–∞—Ä—É–∂–Ω–∞—è –∫–∞–Ω–∞–ª–∏–∑–∞—Ü–∏—è", "base_price": 3500, "description": "–î–æ 10 –º–µ—Ç—Ä–æ–≤"},
            
            # –ú–æ–Ω—Ç–∞–∂ —Å–µ–ø—Ç–∏–∫–æ–≤
            {"category": "–ú–æ–Ω—Ç–∞–∂ —Å–µ–ø—Ç–∏–∫–æ–≤", "service_name": "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ–ø—Ç–∏–∫–∞ –¥–æ 3 –º¬≥", "base_price": 15000, "description": "–ü–æ–¥ –∫–ª—é—á"},
            {"category": "–ú–æ–Ω—Ç–∞–∂ —Å–µ–ø—Ç–∏–∫–æ–≤", "service_name": "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ–ø—Ç–∏–∫–∞ 3-5 –º¬≥", "base_price": 25000, "description": "–ü–æ–¥ –∫–ª—é—á"},
            {"category": "–ú–æ–Ω—Ç–∞–∂ —Å–µ–ø—Ç–∏–∫–æ–≤", "service_name": "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ–ø—Ç–∏–∫–∞ —Å–≤—ã—à–µ 5 –º¬≥", "base_price": 35000, "description": "–ü–æ–¥ –∫–ª—é—á"},
            
            # –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
            {"category": "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã", "service_name": "–í–∏–¥–µ–æ–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ç—Ä—É–±–æ–ø—Ä–æ–≤–æ–¥–∞", "base_price": 2000, "description": "–î–æ 20 –º–µ—Ç—Ä–æ–≤"},
            {"category": "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã", "service_name": "–≠–∫—Å–ø–µ—Ä—Ç–∏–∑–∞ —Å–µ–ø—Ç–∏–∫–∞", "base_price": 1500, "description": "–û—Ü–µ–Ω–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è"},
            {"category": "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã", "service_name": "–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞", "base_price": 500, "description": "–ù–∞ –æ–±—ä–µ–∫—Ç–µ"},
        ]
        
        logger.info(f"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ {len(default_prices)} –ø–æ–∑–∏—Ü–∏–π –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–∞")

    async def show_price_menu(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–∞."""
        await update.message.reply_text(
            "üí∞ **–ü—Ä–∞–π—Å-–ª–∏—Å—Ç –ö–∞–Ω–∞–ª–¢–µ—Ö–°–µ—Ä–≤–∏—Å**\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —É—Å–ª—É–≥:",
            parse_mode='Markdown',
            reply_markup=self.kb.price_categories()
        )

    async def show_category_prices(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∫–∞–∑–∞—Ç—å —Ü–µ–Ω—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏."""
        query = update.callback_query
        await query.answer()

        if query.data == "back_main":
            await query.edit_message_text("–í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é...")
            return

        category_map = {
            "price_septic": "–û—Ç–∫–∞—á–∫–∞ —Å–µ–ø—Ç–∏–∫–æ–≤",
            "price_cleaning": "–ü—Ä–æ—á–∏—Å—Ç–∫–∞ –∫–∞–Ω–∞–ª–∏–∑–∞—Ü–∏–∏",
            "price_blockage": "–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞—Å–æ—Ä–æ–≤",
            "price_installation": "–ú–æ–Ω—Ç–∞–∂ —Å–µ–ø—Ç–∏–∫–æ–≤",
            "price_diagnostics": "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã"
        }

        category = category_map.get(query.data)
        if not category:
            await query.edit_message_text("‚ùå –ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
            return

        prices = self.db.get_prices_by_category(category)
        
        if not prices:
            # –ï—Å–ª–∏ –≤ –ë–î –Ω–µ—Ç —Ü–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ
            text = self.get_default_category_text(category)
        else:
            text = f"üí∞ **{category}**\n\n"
            for price in prices:
                text += (
                    f"üìã {price['service_name']}\n"
                    f"üíµ –æ—Ç {price['base_price']:.0f} —Ä—É–±.\n"
                    f"üìù {price.get('description', '')}\n\n"
                )

        text += "\n‚ö†Ô∏è –¢–æ—á–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ—Å–º–æ—Ç—Ä–∞ –æ–±—ä–µ–∫—Ç–∞."

        await query.edit_message_text(
            text,
            parse_mode='Markdown',
            reply_markup=self.kb.price_categories()
        )

    def get_default_category_text(self, category):
        """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç —Å —Ü–µ–Ω–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏."""
        texts = {
            "–û—Ç–∫–∞—á–∫–∞ —Å–µ–ø—Ç–∏–∫–æ–≤": (
                "üí∞ **–û—Ç–∫–∞—á–∫–∞ —Å–µ–ø—Ç–∏–∫–æ–≤**\n\n"
                "üìã –î–æ 5 –º¬≥\nüíµ –æ—Ç 2500 —Ä—É–±.\n\n"
                "üìã 5-10 –º¬≥\nüíµ –æ—Ç 4000 —Ä—É–±.\n\n"
                "üìã –°–≤—ã—à–µ 10 –º¬≥\nüíµ –æ—Ç 6000 —Ä—É–±.\n\n"
                "üìã –°—Ä–æ—á–Ω–∞—è –æ—Ç–∫–∞—á–∫–∞ (2 —á–∞—Å–∞)\nüíµ –æ—Ç 3500 —Ä—É–±.\n"
            ),
            "–ü—Ä–æ—á–∏—Å—Ç–∫–∞ –∫–∞–Ω–∞–ª–∏–∑–∞—Ü–∏–∏": (
                "üí∞ **–ü—Ä–æ—á–∏—Å—Ç–∫–∞ –∫–∞–Ω–∞–ª–∏–∑–∞—Ü–∏–∏**\n\n"
                "üìã –ü—Ä–æ—Å—Ç–æ–π –∑–∞—Å–æ—Ä\nüíµ –æ—Ç 1500 —Ä—É–±.\n\n"
                "üìã –°–ª–æ–∂–Ω—ã–π –∑–∞—Å–æ—Ä\nüíµ –æ—Ç 3000 —Ä—É–±.\n\n"
                "üìã –ì–∏–¥—Ä–æ–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –ø—Ä–æ—á–∏—Å—Ç–∫–∞\nüíµ –æ—Ç 4500 —Ä—É–±.\n"
            ),
            "–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞—Å–æ—Ä–æ–≤": (
                "üí∞ **–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞—Å–æ—Ä–æ–≤**\n\n"
                "üìã –£–Ω–∏—Ç–∞–∑/—Ä–∞–∫–æ–≤–∏–Ω–∞\nüíµ –æ—Ç 1200 —Ä—É–±.\n\n"
                "üìã –°—Ç–æ—è–∫\nüíµ –æ—Ç 2500 —Ä—É–±.\n\n"
                "üìã –ù–∞—Ä—É–∂–Ω–∞—è –∫–∞–Ω–∞–ª–∏–∑–∞—Ü–∏—è\nüíµ –æ—Ç 3500 —Ä—É–±.\n"
            ),
            "–ú–æ–Ω—Ç–∞–∂ —Å–µ–ø—Ç–∏–∫–æ–≤": (
                "üí∞ **–ú–æ–Ω—Ç–∞–∂ —Å–µ–ø—Ç–∏–∫–æ–≤**\n\n"
                "üìã –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–æ 3 –º¬≥ –ø–æ–¥ –∫–ª—é—á\nüíµ –æ—Ç 15000 —Ä—É–±.\n\n"
                "üìã –£—Å—Ç–∞–Ω–æ–≤–∫–∞ 3-5 –º¬≥ –ø–æ–¥ –∫–ª—é—á\nüíµ –æ—Ç 25000 —Ä—É–±.\n\n"
                "üìã –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–≤—ã—à–µ 5 –º¬≥ –ø–æ–¥ –∫–ª—é—á\nüíµ –æ—Ç 35000 —Ä—É–±.\n"
            ),
            "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã": (
                "üí∞ **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã**\n\n"
                "üìã –í–∏–¥–µ–æ–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (–¥–æ 20–º)\nüíµ –æ—Ç 2000 —Ä—É–±.\n\n"
                "üìã –≠–∫—Å–ø–µ—Ä—Ç–∏–∑–∞ —Å–µ–ø—Ç–∏–∫–∞\nüíµ –æ—Ç 1500 —Ä—É–±.\n\n"
                "üìã –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –Ω–∞ –æ–±—ä–µ–∫—Ç–µ\nüíµ –æ—Ç 500 —Ä—É–±.\n"
            ),
        }
        return texts.get(category, "–¶–µ–Ω—ã —É—Ç–æ—á–Ω—è–π—Ç–µ —É –º–µ–Ω–µ–¥–∂–µ—Ä–∞.")
